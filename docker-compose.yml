# Demo Recorder MCP - Docker Compose
#
# This setup runs both Playwright MCP and demo-recorder MCP in a single container
# with a shared virtual display (Xvfb) for headless browser recording.
#
# Usage:
#   podman-compose build     # Build the container image
#   podman-compose up -d     # Start the container
#   podman-compose logs -f   # Follow logs
#   podman-compose down      # Stop the container
#
# For direct podman usage:
#   podman build -t demo-recorder-mcp .
#   podman run -it --rm -v ./recordings:/app/recordings demo-recorder-mcp

services:
  demo-recorder:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: demo-recorder-mcp
    environment:
      # Virtual display configuration
      - DISPLAY=:99
      - XVFB_RESOLUTION=1920x1080x24
      # OpenAI API key for TTS (optional)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # Mark as container environment
      - CONTAINER=podman
    volumes:
      # Mount recordings directory for output
      - ./recordings:/app/recordings
    # Run both MCPs
    command: ["/app/run-mcp.sh", "both"]
    # Keep stdin open for MCP stdio communication
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    healthcheck:
      test: ["CMD", "pgrep", "-f", "Xvfb"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Optional: Standalone Playwright MCP only
  playwright:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: playwright-mcp
    environment:
      - DISPLAY=:99
      - XVFB_RESOLUTION=1920x1080x24
    volumes:
      - ./recordings:/app/recordings
    command: ["/app/run-mcp.sh", "playwright"]
    stdin_open: true
    tty: true
    profiles:
      - playwright-only
    deploy:
      resources:
        limits:
          memory: 4G

  # Optional: Standalone demo-recorder MCP only
  recorder:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: recorder-mcp
    environment:
      - DISPLAY=:99
      - XVFB_RESOLUTION=1920x1080x24
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - CONTAINER=podman
    volumes:
      - ./recordings:/app/recordings
    command: ["/app/run-mcp.sh", "demo-recorder"]
    stdin_open: true
    tty: true
    profiles:
      - recorder-only
    deploy:
      resources:
        limits:
          memory: 2G




















